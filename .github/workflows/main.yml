name: Deploy Frontend

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - '*.txt'
      - 'README*'
      - 'CHANGELOG*'
      - 'docs/**'
      - 'documentation/**'
      - '.github/**'
      - 'img/**'
      - 'images/**'
      - 'assets/images/**'
      - 'public/images/**'
      - 'static/images/**'
      - 'src/assets/images/**'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.jpeg'
      - '**/*.gif'
      - '**/*.svg'
      - '**/*.ico'
      - '.gitignore'
      - '.gitattributes'
      - 'LICENSE*'
      - '.editorconfig'
      - '.vscode/**'
      - '.idea/**'

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.changes.outputs.should_deploy }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for important changes
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Define important file patterns for frontend
          IMPORTANT_PATTERNS=(
            "*.js"
            "*.jsx"
            "*.ts"
            "*.tsx"
            "*.vue"
            "*.svelte"
            "*.html"
            "*.css"
            "*.scss"
            "*.sass"
            "*.less"
            "*.styl"
            "package.json"
            "package-lock.json"
            "yarn.lock"
            "pnpm-lock.yaml"
            "Dockerfile*"
            "docker-compose.yml"
            "nginx.conf"
            "nginx/**"
            "next.config.*"
            "nuxt.config.*"
            "vite.config.*"
            "webpack.config.*"
            "rollup.config.*"
            "tailwind.config.*"
            "postcss.config.*"
            "tsconfig.json"
            "jsconfig.json"
            "babel.config.*"
            "eslint.config.*"
            ".eslintrc*"
            "prettier.config.*"
            ".prettierrc*"
            "src/**"
            "public/**"
            "static/**"
            "assets/**"
            "components/**"
            "composables/**"
            "pages/**"
            "views/**"
            "layouts/**"
            "app/**"
            "utils/**"
            "helpers/**"
            "lib/**"
            "libs/**"
            "hooks/**"
            "context/**"
            "contexts/**"
            "store/**"
            "stores/**"
            "redux/**"
            "state/**"
            "styles/**"
            "css/**"
            "scss/**"
            "api/**"
            "services/**"
            "middleware/**"
            "plugins/**"
            "locales/**"
            "i18n/**"
            "types/**"
            "interfaces/**"
            "models/**"
            "schemas/**"
            ".env*"
            "env.*"
          )

          # Check if any important files changed
          SHOULD_DEPLOY=false
          for pattern in "${IMPORTANT_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -E "$pattern" > /dev/null; then
              SHOULD_DEPLOY=true
              echo "Found important changes in files matching: $pattern"
              break
            fi
          done

          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "Should deploy: $SHOULD_DEPLOY"

  notify:
    runs-on: ubuntu-latest
    needs: check_changes
    steps:
      - name: Send Telegram Message
        run: |
          # Determine deployment status
          if [ "${{ needs.check_changes.outputs.should_deploy }}" == "true" ]; then
            DEPLOY_STATUS="ðŸš€ Will be deployed"
            DEPLOY_EMOJI="ðŸš€"
          else
            DEPLOY_STATUS="â­ï¸ Skipped (no important changes)"
            DEPLOY_EMOJI="â­ï¸"
          fi

          echo "Deployment Status: $DEPLOY_STATUS"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
              "text": "'$DEPLOY_EMOJI' *Frontend Push Detected!*\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.event.head_commit.message }}\nAuthor: ${{ github.actor }}\nStatus: '$DEPLOY_STATUS'",
              "parse_mode": "Markdown",
              "disable_web_page_preview": true,
              "reply_markup": {
                "inline_keyboard": [
                  [
                    {
                      "text": "ðŸ“‹ View Changes",
                      "url": "${{ github.event.compare }}"
                    },
                    {
                      "text": "ðŸ“‚ Repository",
                      "url": "${{ github.event.repository.html_url }}"
                    }
                  ]
                ]
              }
            }'

  deploy:
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_deploy == 'true'
    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH Host Key
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts # Pastikan izinnya benar

      - name: Deploy Frontend to Server
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            # Masuk ke direktori utama proyek di server
            cd combiphar
            
            # Masuk ke folder frontend dan tarik kode terbaru dari repositori frontend Anda
            cd frontend
            git pull origin main # Asumsi branch default adalah main
            
            # Kembali ke direktori utama docker-compose
            cd .. 
            
            # Hentikan dan bangun ulang hanya container frontend
            docker compose up -d --build --no-deps frontend_app
            
            # Opsional: Bersihkan image Docker lama
            docker image prune -f
          EOF

  notify_deployment:
    runs-on: ubuntu-latest
    needs: [check_changes, deploy]
    if: always() && needs.check_changes.outputs.should_deploy == 'true'
    steps:
      - name: Send Deployment Result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            STATUS="âœ… *Frontend Deployment Successful!*"
            EMOJI="âœ…"
          else
            STATUS="âŒ *Frontend Deployment Failed!*"
            EMOJI="âŒ"
          fi

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
              "text": "'$EMOJI' '$STATUS'\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.event.head_commit.message }}",
              "parse_mode": "Markdown",
              "disable_web_page_preview": true,
              "reply_markup": {
                "inline_keyboard": [
                  [
                    {
                      "text": "ðŸ“Š View Workflow",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                ]
              }
            }'
